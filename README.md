# LUA.ZIG
<picture>
  <source media="(prefers-color-scheme: dark)" srcset="https://brainmade.org/white-logo.svg">
  <source media="(prefers-color-scheme: light)" srcset="https://brainmade.org/black-logo.svg">
  <img align="right" width="128" height="40" alt="Brainmade mark". src="https://brainmade.org/black-logo.svg">
</picture>

![License](https://img.shields.io/badge/License-MIT-green?style=for-the-badge&logo=MIT)
![Zig](https://img.shields.io/badge/Zig-%23F7A41D.svg?style=for-the-badge&logo=zig&logoColor=white)

A thin wrapper over [Lua 5.5](https://www.lua.org/manual/5.5/), providing all the goodies of it !
The zig version is the one on the master branch.

## Lua Wrapper
To link / get a module of the Lua Wrapper, one can do the following :
```sh
$ zig fetch --save=lua.zig https://codeberg.org/mathieu_cayeux/lua.zig
```

And in your `build.zig.zon`:
```zig
const lua_zig = b.dependency("lua.zig");
YOUR_MODULE.addImport("lua-zig", lua_zig.module("lua.zig"));
```

If you want solely the C API :
```zig
YOUR_MODULE.addImport("lua-c", lua_zig.module("lua.c"));
```


<details>
<summary>

## Generate the Lua Library

</summary>

Now, the `build.zig` can be used to generate an exact copy of official repo's Lua libraries ! In particular, 
it will create a one-to-one equivalent of what would be generated by `make` :

```sh
PREFIX/
  include/*
  lib/*
  man/man1/*
  bin/*
```

To generate the above, do :
```sh
$ git clone https://codeberg.org/mathieu_cayeux/lua.zig
$ cd lua.zig
$ zig build install -Dskip-zig
```

Note that `skip-zig` will skip any `TranslateC` steps, module creation etc. It should be used
only if you want to create a standard Lua library.

You can also add the option `skip-lua-exes` which will skip creating the `bin` and `man/man1` folder as well as
what it contains, namely the `lua` and `luac` executables and their manpages.

```sh
$ zig build install -Dskip-zig -Dskip-lua-exes
$ file zig-out/bin/
zig-out/bin/: cannot open `zig-out/bin/' (No such file or directory)
```

</details>

### Limitations
The build toolchain uses the [Translate C](https://codeberg.org/ziglang/translate-c) API to generate the bindings.
This is equivalent on older zig build to doing a `@cImport`, but the latter will be removed on later versions.

Note that because lua makes heavy use of macros to make inline calls of functions, some translated call will not work, namely because of [#164](https://codeberg.org/ziglang/translate-c/issues/164) which is a current bug that doesn't coerce `NULL` (the macro) to a pointer's `null`.

As such, some of the following code will get a compile-time error :

```zig
const my_str = lua.lua_tostring(L, -1);
```

will get :

```zig
// ERROR: error: expected type '[*c]usize', found '?*anyopaque'
pub inline fn lua_tostring(L: anytype, i: anytype) @TypeOf(lua_tolstring(L, i, NULL));
//                                                                             ^~~~
// -- snip --
// note: generic function instantiated here
const my_str = lua.lua_tostring(new_state, -1);
```

The fix is as follows :
```zig
const my_str = lua.lua_tostring(new_state, -1);
// TO
const my_str = lua.lua_tolstring(new_state, -1, null);
```

aka. copying what is after the `@TypeOf` in the declaration and swapping the values `NULL` to `null` where applicable.

## License
I'm using [MIT](./LICENSE).
